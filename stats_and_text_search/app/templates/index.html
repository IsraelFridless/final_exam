<!DOCTYPE html>
<html>
<head>
    <title>Terror Events Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .filters-container {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .map-container {
            height: 600px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .container {
            padding-bottom: 40px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>Terror Events Search</h2>

        <div class="filters-container">
            <form id="searchForm" class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Search Query</label>
                    <select class="form-select" id="query" name="query">
                        <option value="groups_by_location_and_mutual_targets">Groups by Location and Mutual Targets</option>
                        <option value="groups_by_attack_type_and_location">Groups by Attack Type and Location</option>
                        <option value="get_coactive_groups_by_location">Coactive Groups by Location</option>
                        <option value="most_active_groups_per_location">Most active Groups per location</option>
                        <option value="coordinates_by_date_range">Geographical Terrorism HeatMap</option>
                        <option value="avg_casualty_score_per_region">Avg casualty score per region</option>
                        <option value="deadliest_attack_type">Deadliest Attack Type</option>
                        <option value="groups_with_highest_casualty_score">Groups with the highest casualty score</option>
                        <option value="group_migration_patterns">Group migration patterns</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Choose Location Type</label>
                    <select class="form-select" id="locationType" name="locationType">
                        <option value="region">Region</option>
                        <option value="country">Country</option>
                        <option value="city">City</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Results Limit</label>
                    <input type="number" class="form-control" id="limit" name="limit">
                </div>

                <div class="row">
                    <!-- Start Year -->
                    <div class="col-md-3">
                        <label class="form-label">Start Year</label>
                        <input type="number" class="form-control" id="startYear" name="start_year" disabled>
                    </div>

                    <!-- Start Month -->
                    <div class="col-md-3">
                        <label class="form-label">Start Month</label>
                        <select class="form-control" id="startMonth" name="start_month" disabled>
                            <option value="" disabled selected>Select Month</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>

                    <!-- End Year -->
                    <div class="col-md-3">
                        <label class="form-label">End Year</label>
                        <input type="number" class="form-control" id="endYear" name="end_year" disabled>
                    </div>

                    <!-- End Month -->
                    <div class="col-md-3">
                        <label class="form-label">End Month</label>
                        <select class="form-control" id="endMonth" name="end_month" disabled>
                            <option value="" disabled selected>Select Month</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                </div>

                <div class="col-12">
                    <button type="button" onclick="initMap()" class="btn btn-primary">Search</button>
                </div>
            </form>
        </div>

        <div class="map-container" id="mapContainer">
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const querySelect = document.getElementById('query');
            const startYearInput = document.getElementById('startYear');
            const startMonthInput = document.getElementById('startMonth');
            const endYearInput = document.getElementById('endYear');
            const endMonthInput = document.getElementById('endMonth');

            querySelect.addEventListener('change', () => {
                // Enable or disable the date fields based on the selected query
                const isCoordinatesQuery = querySelect.value === 'coordinates_by_date_range';
                startYearInput.disabled = !isCoordinatesQuery;
                startMonthInput.disabled = !isCoordinatesQuery;
                endYearInput.disabled = !isCoordinatesQuery;
                endMonthInput.disabled = !isCoordinatesQuery;
            });

            // Trigger the change event on page load to set the initial state
            querySelect.dispatchEvent(new Event('change'));
        });


        const fetchData = async (url) => {
            const response = await fetch(url)
            return await response.json()
        }
        const initMap = async () => {
            const query = document.getElementById('query').value
            const locationType = document.getElementById("locationType").value || 'region';
            const startYear = document.getElementById('startYear').value
            const endYear = document.getElementById('endYear').value
            const startMonth = document.getElementById('startMonth').value
            const endMonth = document.getElementById('endMonth').value
            const limit = document.getElementById('limit').value || 5
            const baseUrl = `http://localhost:5000/api/statistics/${query}`;

             const queryString = new URLSearchParams({
                locationType: locationType,
                startYear: startYear,
                endYear: endYear,
                startMonth: startMonth,
                endMonth: endMonth,
                limit: limit
            }).toString();

            const url = `${baseUrl}?${queryString}`;
            console.log("Generated URL:", url);
            const { map_html } = await fetchData(url);
            const iframe = document.getElementById("mapContainer");
            if (map_html.startsWith("data:image/png;base64")) {
                iframe.innerHTML = `<img src="${map_html}" style="width:100%; height:auto;" />`;
            } else {
                iframe.innerHTML = map_html;
            }
        };

    </script>
</body>
</html>